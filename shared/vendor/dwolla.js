/**
 * Dwolla Payment Button Helper Script
 *
 * @version 3.1.1
 * @author Michael Schonfeld <api@dwolla.com>
 * @url https://developers.dwolla.com
 */

if(function(t){t.DOMReady=function(){var e=[],n=!1,a=null,r=function(t,e){try{t.apply(this,e||[])}catch(n){a&&a.call(this,n)}},i=function(){n=!0;for(var t=0;t<e.length;t++)r(e[t].fn,e[t].args||[]);e=[]};return this.setOnError=function(t){return a=t,this},this.add=function(t,a){return n?r(t,a):e[e.length]={fn:t,args:a},this},t.addEventListener?t.document.addEventListener("DOMContentLoaded",function(){i()},!1):!function(){if(t.document.uniqueID||!t.document.expando){var e=t.document.createElement("document:ready");try{e.doScroll("left"),i()}catch(n){setTimeout(arguments.callee,0)}}}(),this}()}(window),!window.Element){Element=function(){};var __createElement=document.createElement;document.createElement=function(t){var e=__createElement(t);for(var n in Element.prototype)e[n]=Element.prototype[n];return e};var __getElementById=document.getElementById;document.getElementById=function(t){var e=__getElementById(t);for(var n in Element.prototype)e[n]=Element.prototype[n];return e}}var addEvent=function(){var t=function(e,n,a){(t=e.addEventListener?function(t,e,n){t.addEventListener(e,n,!1)}:e.attachEvent?function(t,e,n){t.attachEvent("on"+e,n)}:function(t,e,n){t["on"+e]=n})(e,n,a)};return function(e,n,a){t(e,n,a)}}();getElsByClass=function(t){var e,n,a,r,i,o;if("function"==typeof document.getElementsByClassName)return document.getElementsByClassName(t);if("function"==typeof document.querySelectorAll)return document.querySelectorAll("."+t);for(n=new RegExp("(^|\\s)"+t+"(\\s|$)"),i=document.getElementsByTagName("*"),o=[],a=0,r=i.length;r>a;a++)e=i[a],n.test(e.className)&&o.push(e);return o};var DwollaBtn=DwollaBtn||function(){var t={cssURI:"https://www.dwolla.com/content/button.min.css",dwollaPayAction:"https://uat.dwolla.com/payment/pay",dwollaMisconfiguredPage:"https://developers.dwolla.com/button"};return{_skip:function(t){return t.nextSibling&&t.nextSibling.className&&-1!==t.nextSibling.className.indexOf("d-btn")?!0:!1},_createButton:function(e,n,a){null==a&&(a=!1);var r=document.createElement("a"),i=document.createElement("span");i.setAttribute("class","d-btn-text"),i.appendChild(document.createTextNode(a||e.getAttribute("data-label"))),r.appendChild(i);var o=document.createElement("span");o.setAttribute("class","d-btn-icon"),r.appendChild(o),r.setAttribute("class","d-btn "+n),r.setAttribute("href",t.dwollaMisconfiguredPage);for(var u=0;u<e.attributes.length;u++)"data-"==e.attributes[u].nodeName.substr(0,5)&&r.setAttribute(e.attributes[u].nodeName,e.attributes[u].nodeValue);return r},_parse:function(t){for(var e=[],n=t.split("|||"),a=0;a<n.length;a++){var r=n[a].split(":::"),i={};i.name=r[0],i.price=r[1],i.name&&i.price&&e.push(i)}return e},init:function(){return this.appendCSS(),this.createMarkup(),this.registerButtons(),this.handleResponse(),!0},appendCSS:function(){if(document.getElementById("dwolla-button-stylesheet"))return!1;var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t.cssURI),e.setAttribute("id","dwolla-button-stylesheet"),document.getElementsByTagName("head")[0].appendChild(e)},createMarkup:function(){for(var t=getElsByClass("dwolla_button"),e=0;e<t.length;e++){var n=t[e],a=n.getAttribute("data-type");if(a&&"undefined"!=typeof a){if("simple"==a){if(this._skip(n))return;var r=this._createButton(n,"d-btn-simple");n.parentNode.insertBefore(r,n.nextSibling)}else if("freetype"==a){if(this._skip(n))return;var r=this._createButton(n,"d-btn-freetype"),i=document.createElement("input");i.setAttribute("type","text"),i.setAttribute("onClick","this.select();"),addEvent(i,"keyup",function(t){13==t.keyCode&&DwollaBtn.submitButton(this.parentNode)}),i.value=n.getAttribute("data-amount"),r.appendChild(i),n.parentNode.insertBefore(r,n.nextSibling)}else if("options"==a){if(this._skip(n))return;var r=this._createButton(n,"d-btn-options"),o=document.createElement("select"),u=this._parse(n.getAttribute("data-options")),d=document.createElement("option");d.setAttribute("disabled","disabled"),d.setAttribute("selected","selected"),d.innerHTML="Choose...",o.appendChild(d);for(var l=0;l<u.length;l++){var s=document.createElement("option");s.value=u[l].price+":"+u[l].name,s.innerHTML=u[l].name+" ($"+u[l].price+")",o.appendChild(s)}r.appendChild(o),addEvent(o,"change",function(){var t=this.value.substr(0,this.value.indexOf(":")),e=this.value.substr(this.value.indexOf(":")+1);this.parentNode.setAttribute("data-amount",t.replace("$","")),this.parentNode.setAttribute("data-name",e),DwollaBtn.submitButton(this.parentNode)}),r.setAttribute("data-amount",""),r.setAttribute("data-name",""),n.parentNode.insertBefore(r,n.nextSibling)}}else{if(-1!==n.className.indexOf("d-btn"))return;n.setAttribute("data-redirect",n.getAttribute("href")),n.setAttribute("data-description",n.getAttribute("data-desc"));var r=this._createButton(n,"d-btn-legacy",n.firstChild.nodeValue);n.parentNode.replaceChild(r,n)}}},registerButtons:function(){if(null!=window.DwollaClickEvent)return!1;var t=function(t,e){var n=function(t){return-1!==t.className.indexOf("d-btn")&&"A"==t.nodeName};return n(t)?t:n(e)?e:!1},e=function(e){var n,a=e.target||e.srcElement,r=a.parentNode;return(n=t(a,r))?(e.preventDefault?e.preventDefault():e.returnValue=!1,"INPUT"==a.nodeName||"SELECT"==a.nodeName||"OPTION"==a.nodeName?!1:(DwollaBtn.submitButton(n),!1)):void 0};addEvent(document,"click",e),window.DwollaClickEvent=!0},handleResponse:function(){if(null!=window.DwollaResponseEvent)return!1;var t=function(t){var e=RegExp("[?&]"+t+"=([^&]*)").exec(window.location.search);return e&&decodeURIComponent(e[1].replace(/\+/g," "))};return"failure"==t("error")&&t("error_description")&&DwollaBtn.onFailure(t("error_description")),window.DwollaResponseEvent=!0,!0},submitButton:function(e){if(!e||"A"!=e.nodeName)return!1;if("freetype"==e.getAttribute("data-type")){var n=e.getElementsByTagName("INPUT")[0].value;e.setAttribute("data-amount",n.replace("$",""))}if(!e.getAttribute("data-amount"))return!1;var a=document.createElement("form");a.setAttribute("method","POST"),a.setAttribute("action",t.dwollaPayAction);var r={destinationId:null,amount:e.getAttribute("data-amount"),shipping:e.getAttribute("data-shipping"),tax:e.getAttribute("data-tax"),name:e.getAttribute("data-name"),description:e.getAttribute("data-description"),redirect:e.getAttribute("data-redirect"),key:e.getAttribute("data-key"),orderId:e.getAttribute("data-orderid"),facilitatorAmount:e.getAttribute("data-facilitator-fee"),notes:e.getAttribute("data-notes"),test:e.getAttribute("data-test"),allowFundingSources:e.getAttribute("data-guest-checkout"),callback:e.getAttribute("data-callback")};for(key in r)if(null!=r[key]){var i=document.createElement("input");i.setAttribute("type","hidden"),i.setAttribute("name",key),i.setAttribute("value",r[key]),a.appendChild(i)}if(document.getElementsByTagName("body")[0].appendChild(a),e.getAttribute("data-popup")){var o=e.getAttribute("data-popup-width")||875,u=e.getAttribute("data-popup-height")||475;window.open("about:blank","dwollapopup","width="+o+",height="+u+",resizeable,scrollbars"),a.target="dwollapopup"}setTimeout(function(){a.submit()},500)},onFailure:function(){return!1}}}();"complete"===document.readyState||"interactive"===document.readyState?DwollaBtn.init():DOMReady.add(function(){DwollaBtn.init()});
